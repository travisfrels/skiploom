# Task: Implement Operational Persistence

| Status | Created | Updated |
|--------|---------|---------|
| Open | 2026-02-05 | 2026-02-05 |

## Objective

Replace `InMemoryRecipeRepository` with PostgreSQL-backed persistence, enabling recipes to survive application restarts.

## References

- [ADR-OP-PERSISTENCE-20260205](../adrs/ADR-OP-PERSISTENCE-20260205.md)
- [Engineering Design: Operational Persistence](../ENG-DESIGN.md#operational-persistence)

## Scope

### In Scope

- Add Spring Data JPA, PostgreSQL driver, and Flyway dependencies to `build.gradle.kts`
- Configure PostgreSQL datasource and JPA properties in `application.yml`
- Create JPA entities (`RecipeEntity`, `IngredientEntity`, `StepEntity`) in `infrastructure/persistence/`
- Create mapping layer between domain entities and JPA entities
- Implement `RecipeReader` and `RecipeWriter` using Spring Data JPA repositories
- Write Flyway migration scripts for `recipe`, `ingredient`, and `step` tables
- Add `postgres` service to Docker Compose with a volume mount for data persistence
- Seed initial data via Flyway migration or Spring profile-conditional mechanism
- Configure test infrastructure (H2 or Testcontainers) so existing tests continue to pass
- Add integration tests for the JPA repository implementation

### Out of Scope

- Full-text search beyond `ILIKE` queries
- Backup/restore automation (`pg_dump`/`pg_restore` workflows)
- Production deployment configuration
- Database connection pooling tuning
- Schema changes beyond the three tables defined in the engineering design

## Acceptance Criteria

- [ ] Application starts and connects to PostgreSQL running in Docker
- [ ] All CRUD operations (create, read, update, delete) persist to PostgreSQL
- [ ] Recipes survive application restarts
- [ ] Flyway migrations run on startup and create the schema
- [ ] JPA entities are in the infrastructure layer; domain entities are unchanged
- [ ] Existing unit tests pass without modification
- [ ] Integration tests verify repository operations against a real (or embedded) database
- [ ] `docker compose up` starts both the application and PostgreSQL

## Implementation Notes

- The existing `RecipeReader`/`RecipeWriter` interfaces in `domain/operations/` define the repository contract. The new JPA implementation should implement both, mirroring the pattern established by `InMemoryRecipeRepository`.
- `InMemoryRecipeRepository` is removed â€” see [Repository Activation](../ENG-DESIGN.md#repository-activation).
- Flyway migration scripts go in `src/backend/src/main/resources/db/migration/` (the default `classpath:db/migration` location) following the naming convention `V{number}__{description}.sql`. See [Flyway: Naming Patterns Matter](https://www.red-gate.com/blog/database-devops/flyway-naming-patterns-matter) and [Flyway Migrations Concepts](https://documentation.red-gate.com/flyway/flyway-concepts/migrations).

## Progress Log
