services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
    secrets:
      - postgres_password
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./infra/postgres/init-databases.sql:/docker-entrypoint-initdb.d/init-databases.sql:ro
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5

  forgejo:
    image: codeberg.org/forgejo/forgejo:14
    depends_on:
      postgres:
        condition: service_healthy
    command: >-
      bash -c '
      /usr/bin/s6-svscan /etc/s6 &
      sleep 10 ;
      su -c "forgejo forgejo-cli actions register --keep-labels --secret $$(cat /run/secrets/forgejo_runner_secret)" git ;
      su -c "forgejo admin user create --admin --username root --password $$(cat /run/secrets/forgejo_admin_password) --email root@localhost --must-change-password=false" git ;
      sleep infinity
      '
    environment:
      FORGEJO__database__DB_TYPE: postgres
      FORGEJO__database__HOST: postgres:5432
      FORGEJO__database__NAME: forgejo
      FORGEJO__database__USER: postgres
      FORGEJO__database__PASSWD__FILE: /run/secrets/postgres_password
      FORGEJO__server__ROOT_URL: http://localhost:3000
      FORGEJO__server__HTTP_PORT: "3000"
      FORGEJO__server__SSH_DOMAIN: localhost
      FORGEJO__server__SSH_PORT: "2222"
      FORGEJO__security__INSTALL_LOCK: "true"
      FORGEJO__service__DISABLE_REGISTRATION: "true"
      FORGEJO__actions__ENABLED: "true"
      FORGEJO__repository__ENABLE_PUSH_CREATE_USER: "true"
      FORGEJO__repository__DEFAULT_PUSH_CREATE_PRIVATE: "false"
      FORGEJO__repository__DEFAULT_REPO_UNITS: "repo.code,repo.issues,repo.pulls,repo.actions"
    secrets:
      - postgres_password
      - forgejo_admin_password
      - forgejo_runner_secret
    volumes:
      - forgejo-data:/data
    ports:
      - "3000:3000"
      - "2222:22"
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3000/api/v1/version"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  runner:
    image: data.forgejo.org/forgejo/runner:12.6.3
    depends_on:
      forgejo:
        condition: service_healthy
    secrets:
      - forgejo_runner_secret
    volumes:
      - runner-data:/data
      - /var/run/docker.sock:/var/run/docker.sock
    user: "0:0"
    command: >-
      bash -ec '
      while : ; do
        forgejo-runner create-runner-file --connect --instance http://forgejo:3000 --name runner --secret $$(cat /run/secrets/forgejo_runner_secret) && break ;
        sleep 1 ;
      done ;
      sed -i -e "s|\"labels\": .*|\"labels\": [\"ubuntu:docker://node:22-bookworm\", \"deploy:docker://docker:27\"]|" .runner ;
      forgejo-runner generate-config > config.yml ;
      sed -i -e "s|network: .*|network: skiploom|" config.yml ;
      sed -i -e "s|valid_volumes:.*|valid_volumes: [\"/var/run/docker.sock\"]|" config.yml ;
      sed -i -e "s|docker_host:.*|docker_host: automount|" config.yml ;
      echo "Validating runner configuration..." ;
      grep -q "\"deploy:" .runner || { echo "ERROR: deploy label not found in .runner"; exit 1; } ;
      grep -q "\"ubuntu:" .runner || { echo "ERROR: ubuntu label not found in .runner"; exit 1; } ;
      grep -q "network: skiploom" config.yml || { echo "ERROR: network not set to skiploom in config.yml"; exit 1; } ;
      grep -q "valid_volumes:" config.yml || { echo "ERROR: valid_volumes not configured in config.yml"; exit 1; } ;
      grep -q "docker_host: automount" config.yml || { echo "ERROR: docker_host not set to automount in config.yml"; exit 1; } ;
      echo "Runner configuration validated successfully." ;
      chown -R 1000:1000 /data ;
      exec forgejo-runner --config config.yml daemon
      '

  backend-staging:
    build:
      context: ./src/backend
    profiles: [staging]
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: staging
      DATABASE_URL: jdbc:postgresql://postgres:5432/skiploom-staging
      DATABASE_USERNAME: postgres
      CORS_ALLOWED_ORIGINS: http://localhost:5174
    secrets:
      - spring.datasource.password
      - spring.security.oauth2.client.registration.google.client-id
      - spring.security.oauth2.client.registration.google.client-secret
    ports:
      - "8081:8080"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/api/health"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 30s

  frontend-staging:
    build:
      context: ./src/frontend
    profiles: [staging]
    depends_on:
      backend-staging:
        condition: service_healthy
    environment:
      BACKEND_URL: http://backend-staging:8080
    ports:
      - "5174:80"

networks:
  default:
    name: skiploom

secrets:
  postgres_password:
    file: ./secrets/postgres_password
  forgejo_admin_password:
    file: ./secrets/forgejo_admin_password
  forgejo_runner_secret:
    file: ./secrets/forgejo_runner_secret
  spring.datasource.password:
    file: ./secrets/spring.datasource.password
  spring.security.oauth2.client.registration.google.client-id:
    file: ./secrets/spring.security.oauth2.client.registration.google.client-id
  spring.security.oauth2.client.registration.google.client-secret:
    file: ./secrets/spring.security.oauth2.client.registration.google.client-secret

volumes:
  postgres-data:
  forgejo-data:
  runner-data:
